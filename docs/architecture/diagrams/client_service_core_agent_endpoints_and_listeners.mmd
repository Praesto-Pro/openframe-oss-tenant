flowchart LR
    Agent["Agent Installed On Machine"] -->|"POST /oauth/token"| AuthController["AgentAuthController"]
    Agent -->|"POST /api/agents/register"| AgentController["AgentController"]
    Agent -->|"GET /tool-agent/{assetId}"| FileController["ToolAgentFileController"]

    AgentController --> RegistrationService["AgentRegistrationService"]
    RegistrationService --> Processor["AgentRegistrationProcessor"]

    NATS["NATS / JetStream"] --> HeartbeatListener["MachineHeartbeatListener"]
    NATS --> InstalledAgentListener["InstalledAgentListener"]
    NATS --> ToolConnectionListener["ToolConnectionListener"]
    NATS --> ClientConnectionListener["ClientConnectionListener"]

    HeartbeatListener --> MachineStatusService["MachineStatusService"]
    InstalledAgentListener --> InstalledAgentService["InstalledAgentService"]
    ToolConnectionListener --> ToolConnectionService["ToolConnectionService"]
    ClientConnectionListener --> MachineStatusService
