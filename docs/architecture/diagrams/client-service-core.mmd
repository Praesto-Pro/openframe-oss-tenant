flowchart TD
    Agent["Installed Agent"] -->|"/api/agents/register"| AgentController["AgentController"]
    Agent -->|"/oauth/token"| AgentAuthController["AgentAuthController"]

    AgentController --> AgentRegistrationService["AgentRegistrationService"]
    AgentRegistrationService --> RegistrationProcessor["DefaultAgentRegistrationProcessor"]

    Nats["NATS JetStream"] --> InstalledAgentListener["InstalledAgentListener"]
    Nats --> ToolConnectionListener["ToolConnectionListener"]
    Nats --> MachineHeartbeatListener["MachineHeartbeatListener"]
    Nats --> ClientConnectionListener["ClientConnectionListener"]

    InstalledAgentListener --> InstalledAgentService["InstalledAgentService"]
    ToolConnectionListener --> ToolConnectionService["ToolConnectionService"]
    MachineHeartbeatListener --> MachineStatusService["MachineStatusService"]
    ClientConnectionListener --> MachineStatusService

    ToolConnectionService --> Transformer["ToolAgentIdTransformer"]
    Transformer --> FleetTransformer["FleetMdmAgentIdTransformer"]
    Transformer --> MeshTransformer["MeshCentralAgentIdTransformer"]
