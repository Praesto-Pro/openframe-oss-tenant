suite: test register job template
templates:
  - templates/register-job.yaml
tests:
  - it: should render register job when enabled
    set:
      registerJob.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Job
      - equal:
          path: metadata.name
          value: openframe-gateway

  - it: should not render register job when disabled
    set:
      registerJob.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should configure job correctly
    set:
      registerJob.enabled: true
    asserts:
      - equal:
          path: spec.backoffLimit
          value: 3
      - equal:
          path: spec.template.spec.restartPolicy
          value: Never
      - equal:
          path: spec.template.spec.containers[0].name
          value: register
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/flamingo-stack/registry/curlimages/curl:8.9.1"

  - it: should include ArgoCD annotations
    set:
      registerJob.enabled: true
    asserts:
      - equal:
          path: metadata.annotations["argocd.argoproj.io/hook"]
          value: PostSync
      - equal:
          path: metadata.annotations["argocd.argoproj.io/hook-delete-policy"]
          value: BeforeHookCreation,HookSucceeded

  - it: should use shell command
    set:
      registerJob.enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].command
          content: "/bin/sh"
      - contains:
          path: spec.template.spec.containers[0].command
          content: "-uc"
      - lengthEqual:
          path: spec.template.spec.containers[0].command
          count: 3
