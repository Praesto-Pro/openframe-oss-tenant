suite: test ingress template
templates:
  - templates/ingress.yaml
tests:
  - it: should render localhost ingress
    set:
      deployment.oss.ingress.localhost.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress
      - equal:
          path: metadata.name
          value: openframe-gateway
      - equal:
          path: spec.ingressClassName
          value: nginx
      - equal:
          path: spec.rules[0].host
          value: localhost
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port.name
          value: http

  - it: should render ngrok ingress
    set:
      deployment.oss.ingress.localhost.enabled: false
      deployment.oss.ingress.ngrok.enabled: true
      deployment.oss.ingress.ngrok.url: "test.ngrok.io"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.ingressClassName
          value: ngrok
      - equal:
          path: spec.rules[0].host
          value: "test.ngrok.io"
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port.number
          value: 8100

  - it: should include TLS section for localhost
    set:
      deployment.oss.ingress.localhost.enabled: true
    asserts:
      - equal:
          path: spec.tls[0].hosts[0]
          value: localhost

  - it: should not include TLS for ngrok
    set:
      deployment.oss.ingress.localhost.enabled: false
      deployment.oss.ingress.ngrok.enabled: true
      deployment.oss.ingress.ngrok.url: "test.ngrok.io"
    asserts:
      - isNull:
          path: spec.tls

  - it: should not render when no ingress enabled
    set:
      deployment.oss.ingress.localhost.enabled: false
      deployment.oss.ingress.ngrok.enabled: false
    asserts:
      - hasDocuments:
          count: 0
