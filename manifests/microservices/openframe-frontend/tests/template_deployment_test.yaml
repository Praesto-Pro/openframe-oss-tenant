suite: test deployment template
templates:
  - templates/deployment.yaml
tests:
  - it: should render deployment
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: openframe-frontend
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.selector.matchLabels.app
          value: openframe-frontend

  - it: should configure container correctly
    set:
      image.repo: "test-repo"
      image.tag: "test-tag"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].name
          value: openframe-frontend
      - equal:
          path: spec.template.spec.containers[0].image
          value: "test-repo:test-tag"
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 3000
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: http

  - it: should configure health checks
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: http
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: http

  - it: should have correct liveness probe timing
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 30
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 30
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.timeoutSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 5

  - it: should use configMapRef for environment variables
    asserts:
      - equal:
          path: spec.template.spec.containers[0].envFrom[0].configMapRef.name
          value: microservices

  - it: should include pod annotations
    asserts:
      - equal:
          path: spec.template.metadata.annotations["loki.grafana.com/scrape"]
          value: "true"
