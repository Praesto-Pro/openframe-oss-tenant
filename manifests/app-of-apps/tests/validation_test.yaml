suite: deployment validation tests
templates:
  - templates/argocd-apps.yaml
tests:
  # ========================================
  # VALID DEPLOYMENT SCENARIOS
  # ========================================

  - it: should render valid OSS deployment
    asserts:
      - isKind:
          of: Application
      - equal:
          path: metadata.name
          value: argocd-apps

  - it: should have valid source configuration
    asserts:
      - exists:
          path: spec.sources[0].repoURL
      - exists:
          path: spec.sources[0].targetRevision
      - exists:
          path: spec.sources[0].path

  - it: should have valid destination configuration
    asserts:
      - equal:
          path: spec.destination.name
          value: in-cluster
      - equal:
          path: spec.destination.namespace
          value: argocd

  - it: should have valid sync policy
    asserts:
      - exists:
          path: spec.syncPolicy.automated
      - exists:
          path: spec.syncPolicy.retry
      - equal:
          path: spec.syncPolicy.automated.prune
          value: true
      - equal:
          path: spec.syncPolicy.automated.selfHeal
          value: true

  # ========================================
  # RETRY CONFIGURATION
  # ========================================

  - it: should have valid retry configuration
    asserts:
      - equal:
          path: spec.syncPolicy.retry.limit
          value: 5
      - equal:
          path: spec.syncPolicy.retry.backoff.duration
          value: 15s
      - equal:
          path: spec.syncPolicy.retry.backoff.factor
          value: 2
      - equal:
          path: spec.syncPolicy.retry.backoff.maxDuration
          value: 30m
