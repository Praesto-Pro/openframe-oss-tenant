suite: argocd application configuration tests
templates:
  - templates/argocd-apps.yaml
tests:
  # ========================================
  # APPLICATION METADATA TESTS
  # ========================================

  - it: should have correct ArgoCD application metadata
    asserts:
      - equal:
          path: apiVersion
          value: argoproj.io/v1alpha1
      - equal:
          path: kind
          value: Application
      - equal:
          path: metadata.name
          value: argocd-apps
      - contains:
          path: metadata.finalizers
          content: resources-finalizer.argocd.argoproj.io

  # ========================================
  # APPLICATION SPEC TESTS
  # ========================================

  - it: should have correct project configuration
    asserts:
      - equal:
          path: spec.project
          value: default

  - it: should have correct OSS source configuration
    asserts:
      - equal:
          path: spec.sources[0].repoURL
          value: https://github.com/flamingo-stack/openframe-oss-tenant.git
      - equal:
          path: spec.sources[0].targetRevision
          value: main
      - equal:
          path: spec.sources[0].path
          value: "manifests/apps"
      - exists:
          path: spec.sources[0].helm.values

  - it: should have correct destination configuration
    asserts:
      - equal:
          path: spec.destination.name
          value: in-cluster
      - equal:
          path: spec.destination.namespace
          value: argocd

  # ========================================
  # SYNC POLICY TESTS
  # ========================================

  - it: should have correct default sync policy
    asserts:
      - equal:
          path: spec.syncPolicy.automated.prune
          value: true
      - equal:
          path: spec.syncPolicy.automated.selfHeal
          value: true
      - equal:
          path: spec.syncPolicy.retry.limit
          value: 5

  - it: should have sync policy structure
    asserts:
      - exists:
          path: spec.syncPolicy.automated
      - exists:
          path: spec.syncPolicy.retry

  # ========================================
  # HELM VALUES STRUCTURE TESTS
  # ========================================

  - it: should include required helm values structure
    asserts:
      - matchRegex:
          path: spec.sources[0].helm.values
          pattern: "deployment:"
      - matchRegex:
          path: spec.sources[0].helm.values
          pattern: "environment:"

  # ========================================
  # DOCUMENT COUNT TESTS
  # ========================================

  - it: should generate exactly one ArgoCD application
    asserts:
      - hasDocuments:
          count: 1

  # ========================================
  # CUSTOM CONFIGURATION
  # ========================================

  - it: should handle custom repository configuration
    set:
      deployment.oss.repository.URL: "https://example.com/custom-repo.git"
      deployment.oss.repository.branch: "custom-branch"
      deployment.oss.repository.baseDir: "custom-dir"
      deployment.oss.repository.appsDir: "custom-apps-dir"
    asserts:
      - equal:
          path: spec.sources[0].repoURL
          value: "https://example.com/custom-repo.git"
      - equal:
          path: spec.sources[0].targetRevision
          value: "custom-branch"
      - equal:
          path: spec.sources[0].path
          value: "custom-dir/custom-apps-dir"
