suite: values propagation tests
templates:
  - templates/argocd-apps.yaml
tests:
  # ========================================
  # DEPLOYMENT VALUES PROPAGATION
  # ========================================

  - it: should propagate OSS deployment values
    asserts:
      - matchRegex:
          path: spec.sources[0].helm.values
          pattern: "deployment:"
      - matchRegex:
          path: spec.sources[0].helm.values
          pattern: "oss:"

  # ========================================
  # GLOBAL VALUES PROPAGATION
  # ========================================

  - it: should propagate custom global repository values
    set:
      deployment.oss.repository.URL: "https://custom-repo.com/openframe.git"
      deployment.oss.repository.branch: "development"
      deployment.oss.repository.baseDir: "custom-manifests"
      deployment.oss.repository.appsDir: "custom-apps"
    asserts:
      - equal:
          path: spec.sources[0].repoURL
          value: "https://custom-repo.com/openframe.git"
      - equal:
          path: spec.sources[0].targetRevision
          value: "development"
      - equal:
          path: spec.sources[0].path
          value: "custom-manifests/custom-apps"

  - it: should have hardcoded sync policy
    asserts:
      - equal:
          path: spec.syncPolicy.automated.prune
          value: true
      - equal:
          path: spec.syncPolicy.automated.selfHeal
          value: true

  # ========================================
  # ENVIRONMENT PROPAGATION
  # ========================================

  - it: should propagate environment configuration
    set:
      environment: production
    asserts:
      - matchRegex:
          path: spec.sources[0].helm.values
          pattern: "environment: production"

  - it: should use default environment
    asserts:
      - matchRegex:
          path: spec.sources[0].helm.values
          pattern: "environment: dev"
